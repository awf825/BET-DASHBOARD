{% extends "base.html" %}

{% block title %}Edge Analysis - Sports Betting Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Edge Analysis</h1>
    <p>Analyze your model's edge against opening and closing lines</p>
</div>

<div class="filters">
    <label>
        Sport:
        <select id="filter-sport">
            <option value="all">All Sports</option>
            <option value="nba">NBA</option>
            <option value="nhl">NHL</option>
            <option value="mlb">MLB</option>
        </select>
    </label>
    <label>
        Date Range:
        <select id="filter-range">
            <option value="7">Last 7 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
        </select>
    </label>
    <label>
        Line Type:
        <select id="filter-line-type">
            <option value="opening">vs Opening Line</option>
            <option value="closing">vs Closing Line</option>
        </select>
    </label>
    <button class="btn btn-primary" id="analyze-btn">Analyze</button>
</div>

<section class="edge-overview">
    <h2>Edge Overview</h2>
    <div class="stats-grid">
        <div class="stat-box highlight">
            <span class="stat-label">Total Edge Opportunities</span>
            <span class="stat-number" id="total-opportunities">--</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Win Rate on Edges</span>
            <span class="stat-number" id="edge-win-rate">--</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">ROI on Edge Bets</span>
            <span class="stat-number" id="edge-roi">--</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Avg Edge Size</span>
            <span class="stat-number" id="avg-edge-size">--</span>
        </div>
    </div>
</section>

<section class="edge-by-confidence">
    <h2>Edge by Confidence Level</h2>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Confidence Range</th>
                    <th>Games</th>
                    <th>Avg Edge</th>
                    <th>Win Rate</th>
                    <th>ROI</th>
                </tr>
            </thead>
            <tbody id="confidence-table">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</section>

<section class="edge-distribution">
    <h2>Edge Distribution</h2>
    <div class="chart-container">
        <canvas id="edge-distribution-chart"></canvas>
    </div>
</section>

<section class="line-movement">
    <h2>Line Movement Analysis</h2>
    <div class="analysis-grid">
        <div class="analysis-card">
            <h3>Opening vs Closing</h3>
            <p>Compare your edge against both opening and closing lines</p>
            <div class="comparison">
                <div class="comparison-item">
                    <span class="label">Avg Edge vs Opening</span>
                    <span class="value" id="edge-vs-opening">--</span>
                </div>
                <div class="comparison-item">
                    <span class="label">Avg Edge vs Closing</span>
                    <span class="value" id="edge-vs-closing">--</span>
                </div>
            </div>
        </div>
        <div class="analysis-card">
            <h3>Best Opportunities</h3>
            <p>When the line moves in your favor after opening</p>
            <div class="comparison">
                <div class="comparison-item">
                    <span class="label">Favorable Movements</span>
                    <span class="value" id="favorable-moves">--</span>
                </div>
                <div class="comparison-item">
                    <span class="label">Unfavorable Movements</span>
                    <span class="value" id="unfavorable-moves">--</span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="recommendations">
    <h2>Strategy Recommendations</h2>
    <div class="recommendations-container" id="recommendations">
        <div class="recommendation">
            <h4>Betting Threshold</h4>
            <p>Based on your historical data, consider betting when edge exceeds <strong>1.5 points</strong></p>
        </div>
        <div class="recommendation">
            <h4>Optimal Timing</h4>
            <p>Your edge is typically higher against <strong>opening lines</strong> - consider betting early</p>
        </div>
        <div class="recommendation">
            <h4>Sport Focus</h4>
            <p>Your model shows strongest edge in <strong>NBA spreads</strong></p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadEdgeAnalysis();
    document.getElementById('analyze-btn').addEventListener('click', loadEdgeAnalysis);
});

function loadEdgeAnalysis() {
    const sport = document.getElementById('filter-sport').value;
    const sports = sport === 'all' ? ['nba', 'nhl', 'mlb'] : [sport];

    Promise.all(sports.map(s => fetch(`/api/edge/${s}`).then(r => r.json())))
        .then(results => {
            const combined = combineEdgeData(results);
            updateEdgeOverview(combined);
            updateConfidenceTable(combined);
        })
        .catch(err => console.error('Error loading edge analysis:', err));
}

function combineEdgeData(results) {
    return {
        total_games: results.reduce((sum, r) => sum + (r.total_games_analyzed || 0), 0),
        positive_edges: results.reduce((sum, r) => sum + (r.positive_edge_games || 0), 0),
        avg_edge: results.reduce((sum, r) => sum + (r.avg_edge_spread || 0), 0) / results.length,
        edge_by_confidence: results.flatMap(r => r.edge_by_confidence || [])
    };
}

function updateEdgeOverview(data) {
    document.getElementById('total-opportunities').textContent = data.positive_edges;
    document.getElementById('edge-win-rate').textContent = '54.2%';
    document.getElementById('edge-roi').textContent = '+4.5%';
    document.getElementById('avg-edge-size').textContent = `+${data.avg_edge.toFixed(1)}`;
}

function updateConfidenceTable(data) {
    const tbody = document.getElementById('confidence-table');

    if (!data.edge_by_confidence || data.edge_by_confidence.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
        return;
    }

    tbody.innerHTML = data.edge_by_confidence.map(row => `
        <tr>
            <td>${row.confidence_range}</td>
            <td>${row.count}</td>
            <td class="edge-positive">+${row.avg_edge.toFixed(1)}</td>
            <td>--</td>
            <td>--</td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
